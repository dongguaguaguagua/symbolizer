name: Build & Deploy Frontend

on:
    push:
        branches: [main]
        paths:
            - "frontend/**"

jobs:
    build-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install deps
              working-directory: frontend
              run: npm install

            - name: Copy ONNX wasm
              working-directory: frontend
              run: |
                  mkdir -p public/ort
                  cp node_modules/onnxruntime-web/dist/*.wasm public/ort/

            - name: Build
              working-directory: frontend
              run: npm run build

            - name: Deploy to Cloudflare Pages
              uses: cloudflare/pages-action@v1
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  projectName: symbolizer
                  directory: frontend/out
